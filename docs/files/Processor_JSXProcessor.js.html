<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Processor/JSXProcessor.js - JSXPath - xpath query language for JSON documents</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="JSXPath - xpath query language for JSON documents" width="117" height="52">JSXPath - xpath query language for JSON documents</h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 1.2.9</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/JSXAxisTokens.html">JSXAxisTokens</a></li>
                                <li><a href="../classes/JSXOperatorTokens.html">JSXOperatorTokens</a></li>
                                <li><a href="../classes/JSXPath.html">JSXPath</a></li>
                                <li><a href="../classes/JSXPathFunctions.html">JSXPathFunctions</a></li>
                                <li><a href="../classes/JSXProcessor.html">JSXProcessor</a></li>
                                <li><a href="../classes/JSXReplacer.html">JSXReplacer</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/JSXPath.html">JSXPath</a></li>
                                <li><a href="../modules/Parser.html">Parser</a></li>
                                <li><a href="../modules/Processor.html">Processor</a></li>
                                <li><a href="../modules/Tokens.html">Tokens</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: Processor/JSXProcessor.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
var JSXPathParser = require(&quot;../Parser/JSXPathParser&quot;);
var JSXPloder = require(&quot;../Exploder/JSXPloder&quot;);
var JSXPathFunctions = require(&quot;../Tokens/JSXPathFunctions&quot;);
var JSXOperatorTokens = require(&quot;../Tokens/JSXOperatorTokens&quot;);
var JSXAxisTokens = require(&quot;../Tokens/JSXAxisTokens&quot;);
var JSXError = require(&quot;../Utils/JSXError&quot;);
var JSXDebugConfig = require(&quot;../JSXDebugConfig&quot;);
var JSXValidator = require(&quot;../Utils/JSXValidator&quot;);
/**
 * @module Processor
 */

/**
 * @class JSXProcessor
 * @constructor
 * @params {Object} poCustomFunctions Object containing custom funnctions
 */
class JSXProcessor {
	constructor(poCustomFunctions) {
		//debug
		this.DEBUG = JSXDebugConfig.debugOn;
		this.SHOWEXPLODED = JSXDebugConfig.showExploded;
		this.SHOWPROCESSTYPE = JSXDebugConfig.showProcessType;

		//Objects
		this.PathParser = new JSXPathParser();
		this.Exploder = new JSXPloder();
		this.PathFunctions = new JSXPathFunctions(undefined, poCustomFunctions);
		this.OperatorTokens = new JSXOperatorTokens();
		this.ContextTokens = new JSXAxisTokens();
		this.ErrorHandler = new JSXError();
		this.Validator = new JSXValidator();

		//variables
		this.variables = {};
		this.path = null;
		this.parsedPath = [];
		this.json = null;
		this.exploded = {};
	}


	setJSON(poJSON) {
		this.ErrorHandler.test(&quot;DefinedAndValidType&quot;, { data: poJSON, name: &quot;poJSON&quot;, type: typeof poJSON, expectedType: &quot;object&quot;, at: &quot;JSXProcessor.setJSON&quot; });
		this.json = poJSON;
	}
	/**
	 * @method process
	 * @description Main function to process
	 * @param  {String} psPath The path expression.
	 * @param  {Object} [poJSON] The input json object to be traversed against.
	 * @param  {Object} [poVariables] An object containing user defined variables.
	 * @return {any} processed result.
	 */
	process(psPath, poJSON, poVariables) {
		this.ErrorHandler.test(&quot;DefinedAndValidType&quot;, { data: psPath, name: &quot;psPath&quot;, type: typeof psPath, expectedType: &quot;string&quot;, at: &quot;JSXProcessor.process&quot; })
		this.ErrorHandler.test(&quot;ValidType&quot;, { data: poJSON, name: &quot;poJSON&quot;, type: typeof poJSON, expectedType: &quot;object&quot;, at: &quot;JSXProcessor.process&quot; })
		this.ErrorHandler.test(&quot;ValidType&quot;, { data: poVariables, name: &quot;poJSON&quot;, type: typeof poJSON, expectedType: &quot;object&quot;, at: &quot;JSXProcessor.process&quot; });

		if (poVariables) {
			this.variables = poVariables;
		}

		if (poJSON) {
			this.json = poJSON;
			this.exploded = this.Exploder.explode(this.json);
			/* istanbul ignore if */
			if (this.DEBUG &amp;&amp; this.SHOWEXPLODED) console.log(new Date(), &quot;JSXProcessor:this.exploded&quot;, this.exploded);
		}

		this.path = psPath;
		this.parsedPath = this.PathParser.parse(this.path, this.variables, Object.keys(this.exploded));
		/* istanbul ignore if */
		if (this.DEBUG) console.log(new Date(), &quot;JSXProcessor:this.parsedPath&quot;, JSON.stringify(this.parsedPath));


		this.ErrorHandler.test(&quot;Defined&quot;, { data: this.path, name: &quot;this.path&quot;, at: &quot;JSXProcessor.process&quot; });
		this.ErrorHandler.test(&quot;Defined&quot;, { data: this.json, name: &quot;this.json&quot;, at: &quot;JSXProcessor.process&quot; });

		return this._processPath(this.parsedPath, this.exploded);
	}
	/**
	 * @private
	 * 
	 * @method _processPath
	 * @param  {Array} paPath Array construct of the path
	 * @param  {Object} exploded Flattened/exploded form of the initial json
	 * @return {any} Processed result
	 */
	_processPath(paPath, exploded) {
		var result, aArg;
		var bArg = false;
		this.Exploder.addCurrentContext();

		for (var i = 0; i &lt; paPath.length; ++i) {
			if (paPath[i] === &quot;,&quot;) {
				aArg = [];
				bArg = true;
			} else if (paPath[i] === &quot;[&quot;) {
				result = this._tests(paPath.slice(i + 1, paPath.length), exploded);
				if (!result || Array.isArray(result) &amp;&amp; !result.length) {
					return result;
				} else if (Array.isArray(result)){
					this.Exploder.updateCurrent({values: result})
				} else {
					return this.Exploder.current();
				}
				break;
			} else {
				result = this._processArrayElement(aArg &amp;&amp; aArg || result, paPath[i], paPath[i+1], exploded);
				if (!result) //tests resturns a false result
					return result;

				if (this.OperatorTokens.tokens[paPath[i]]) {
					++i;
				} else if (bArg) {
					aArg.push(result);
					this.Exploder.resetCurrentContext();
				}
			}
		}

		if (bArg) {
			return aArg;
		}

		this.Exploder.removeCurrentContext();
		return result;
	}
	/**
	 * @private
	 * 
	 * @method _processCurrentNode
	 * @description Returns the current node after parsing the list of keys that denotes the document path
	 * @param  {Array&lt;String&gt;} pasNodes A list of node string denoting the document path
	 * @return {Object} The current node
	 */
	_processCurrentNode(pasNodes) {
		var i = 0;
		var result;
		if (pasNodes[0] === &quot;@&quot;) {
			this.Exploder.updateCurrent({ 
				name: pasNodes[0], 
				parent: null
			});
			++i;
		}

		if (this.Exploder.current().name === &quot;#ERR&quot;)
			return this.Exploder.current().value;

		for (; i &lt; pasNodes.length; ++i) {
			switch (pasNodes[i]) {
				case &quot;.&quot;:
					break;
				case &quot;..&quot;:
					this.Exploder.setParentAsCurrent();
					break;
				case &quot;&quot;: 
					break;
				default:
					if (this.variables.hasOwnProperty(pasNodes[i])) {
						pasNodes[i] = this.variables[pasNodes[i]];
					}
					this.Exploder.setCurrentToChildNode(pasNodes[i]);
			}
		}
		return this.Exploder.current();
	}
	/**
	 * @private
	 * 
	 * @method _test
	 * @description Function to parse a predicates.
	 * @param  {Array} paPath Array construct of the path
	 * @param  {Object} exploded Flattened/exploded form of the initial json
	 * @return {any} Processed result
	 */
	_tests(paPath, exploded) {
		return this._processPath(paPath, exploded);
	}
	/**
	 * @private
	 * 
	 * @method _type
	 * @description Function to determine what type of element is in the parsed array.
	 * @param  {String|Array} pPath The element of the path array construct.
	 * @param  {Object} poRef The exploded json.
	 * @return {String} The JSXPath enum type
	 */
	_type(pPath, poRef) {
		if (undefined === pPath)
			throw new Error(&quot;Path is not defined.&quot;);
		if (null === pPath)
			return &quot;null&quot;;
		else if (Array.isArray(pPath))
			return &quot;array&quot;;
		else if (pPath.indexOf(&quot;&#x27;&quot;) === 0 &amp;&amp; pPath.lastIndexOf(&quot;&#x27;&quot;) === pPath.length-1 || 
				 pPath.indexOf(&#x27;&quot;&#x27;) === 0 &amp;&amp; pPath.lastIndexOf(&#x27;&quot;&#x27;) === pPath.length-1)
			return &quot;string&quot;;
		else if (parseFloat(pPath) === parseFloat(pPath))
			return &quot;number&quot;;
		else if (this.OperatorTokens.tokens[pPath])
			return &quot;operator&quot;;
		else if (poRef[pPath])
			return &quot;node&quot;;
		else if (/*pPath.indexOf(&quot;@&quot;) &gt; -1 &amp;&amp; */pPath.indexOf(&quot;/&quot;) &gt; -1)
			return &quot;path&quot;;
		else if (pPath.indexOf(&quot;(&quot;) &gt; -1)
			return &quot;function&quot;;
		else if (pPath.indexOf(&quot;$&quot;) &gt; -1)
			return &quot;variable&quot;;
		else if (pPath === &quot;,&quot;) //preprocessed
			return &quot;args&quot;;
		else if (pPath === &quot;[&quot;) //preprocessed
			return &quot;tests&quot;;
		else {
			return null;
		}
	}
	/**
	 * @private
	 * 
	 * @method _processArrayElement
	 * @description Process the current element
	 * @param  {any} prev The previous parsed element
	 * @param  {any} current The current element
	 * @param  {any} next The next element to be parsed
	 * @param  {Object} exploded The flattened/exploded json
	 * @return {Object} The parsed result of the current element.
	 */
	_processArrayElement(prev, current, next, exploded) {
		var result;
		let sType = this._type(current, exploded)
		switch (sType) {
			case &quot;array&quot;: 
				result = this._processPath(current, exploded);
				break;
			case &quot;path&quot;:
				var sPath = current;
				var asNodes = sPath.split(&quot;/&quot;);
				result = this._processCurrentNode(asNodes);
				break;
			case &quot;null&quot;: 
				break;
			case &quot;number&quot;: 
				result = Number(current);
				break;
			case &quot;string&quot;: 
				result = current.substring(1, current.length - 1);
				break;
			case &quot;function&quot;: 
				var args = Array.isArray(prev) ? prev : [prev];
				let sFName = current.substring(0, current.length - 1).trim();
				if (this.ContextTokens.tokens[sFName]) {
					result = this.ContextTokens.tokens[sFName].apply(this, [this.exploded, prev, this.Exploder._explode()]);
					if (Array.isArray(result)) {
						this.Exploder.updateCurrent({ values: result });
						this.Exploder.addCurrentContext();
					} else if (result.name) {
						this.Exploder.updateCurrent({
							name: result.name, 
							parent: result.parent
						});
						this.Exploder.addCurrentContext();
					}
				} else if (this.PathFunctions.customs &amp;&amp; this.PathFunctions.customs.hasOwnProperty(sFName)) {
					result = this.PathFunctions.customs[sFName].apply(this, [args, this.Validator]);
				} else {
					result = this.PathFunctions.tokens[sFName].apply(this, [args]);
				}
				break;
			case &quot;node&quot;:
				if (current === &quot;.&quot;) {
					result = this.Exploder.current();
				} else if (current == &quot;..&quot;) {
					result = this.ContextTokens[&quot;..&quot;](this.exploded);
				} else {
					this.Exploder.setCurrentToChildNode(current);
					result = this.Exploder.current();
				}
				break;
			case &quot;operator&quot;:
				var opfunc = this.OperatorTokens.tokens[current].apply(this, [prev]);
				var nextResult = this._processArrayElement(null, next, null, exploded);
				result = opfunc.apply(null, [nextResult]);
				this.Exploder.resetCurrentContext();
				break;
			case &quot;variable&quot;:
				this.ErrorHandler.test(&quot;Defined&quot;, {data: this.variables[current], name: current, at: &quot;JSXProcessor:_processArrayElement&quot;});
				result = this.variables[current];
				break;
			case &quot;args&quot;: //handled in preporcess
				break;
			case &quot;tests&quot;: //handled in preprocess
				break;
			default:
				// this.ErrorHandler.throw(&quot;jsx000&quot;, {name: current, at: &quot;JSXProcessor:_processArrayElement&quot;})
				console.log(&quot;default&quot;, current, &quot;prev&quot;, prev, this.Exploder.current());
		}
		/* istanbul ignore if */
		if (this.DEBUG &amp;&amp; this.SHOWPROCESSTYPE) console.log(new Date(), &quot;JSXProcessor:&quot; + sType.toUpperCase(), &quot;current&quot;, JSON.stringify(current), &quot;result:&quot;, JSON.stringify(result));
		return result;
	}
};

module.exports = JSXProcessor;
    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
